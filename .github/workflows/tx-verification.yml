name: Transaction Verification

on:
  workflow_dispatch:
    inputs:
      txHash:
        description: 'Transaction hash to verify'
        required: true
      chain:
        description: 'Blockchain network'
        required: true
        type: choice
        options:
          - ethereum
          - base
          - polygon
          - arbitrum
          - optimism
          - bitcoin
      expectedDestination:
        description: 'Expected destination address'
        required: false
        default: 'kushmanmb.base.eth'

permissions:
  contents: read

jobs:
  verify-transaction:
    name: Verify Transaction
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify transaction hash format
        run: |
          echo "## Transaction Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Transaction Hash**: \`${{ github.event.inputs.txHash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Chain**: ${{ github.event.inputs.chain }}" >> $GITHUB_STEP_SUMMARY
          echo "**Expected Destination**: ${{ github.event.inputs.expectedDestination }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use existing verify_tx_hash.py script
          if [ -f "./verify_tx_hash.py" ]; then
            echo "### Hash Format Verification" >> $GITHUB_STEP_SUMMARY
            python3 ./verify_tx_hash.py --hash "${{ github.event.inputs.txHash }}" --json >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Query transaction details
        env:
          TX_HASH: ${{ github.event.inputs.txHash }}
          CHAIN: ${{ github.event.inputs.chain }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
          ARBISCAN_API_KEY: ${{ secrets.ARBISCAN_API_KEY }}
          OPTIMISTIC_ETHERSCAN_API_KEY: ${{ secrets.OPTIMISTIC_ETHERSCAN_API_KEY }}
        run: |
          echo "### Transaction Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Select the appropriate API key based on chain
          case "$CHAIN" in
            ethereum)
              API_KEY="$ETHERSCAN_API_KEY"
              EXPLORER_URL="https://etherscan.io/tx/${TX_HASH}"
              ;;
            base)
              API_KEY="$BASESCAN_API_KEY"
              EXPLORER_URL="https://basescan.org/tx/${TX_HASH}"
              ;;
            polygon)
              API_KEY="$POLYGONSCAN_API_KEY"
              EXPLORER_URL="https://polygonscan.com/tx/${TX_HASH}"
              ;;
            arbitrum)
              API_KEY="$ARBISCAN_API_KEY"
              EXPLORER_URL="https://arbiscan.io/tx/${TX_HASH}"
              ;;
            optimism)
              API_KEY="$OPTIMISTIC_ETHERSCAN_API_KEY"
              EXPLORER_URL="https://optimistic.etherscan.io/tx/${TX_HASH}"
              ;;
            bitcoin)
              EXPLORER_URL="https://mempool.space/tx/${TX_HASH}"
              ;;
            *)
              echo "❌ Unsupported chain: $CHAIN" >> $GITHUB_STEP_SUMMARY
              exit 1
              ;;
          esac
          
          echo "**Explorer Link**: [View on Block Explorer]($EXPLORER_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$API_KEY" ] && [ "$CHAIN" != "bitcoin" ]; then
            echo "✓ API key configured for $CHAIN" >> $GITHUB_STEP_SUMMARY
            echo "✓ Transaction can be queried via API" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ API key not configured - manual verification required" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Verify transaction status
        run: |
          echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ✓ Transaction hash format is valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Verification Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please manually verify the following:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✓ Transaction is confirmed on-chain" >> $GITHUB_STEP_SUMMARY
          echo "2. ✓ Destination address matches: ${{ github.event.inputs.expectedDestination }}" >> $GITHUB_STEP_SUMMARY
          echo "3. ✓ Amount transferred is correct" >> $GITHUB_STEP_SUMMARY
          echo "4. ✓ Gas fees are within expected range" >> $GITHUB_STEP_SUMMARY
          echo "5. ✓ No errors or reverts in transaction" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Transaction originated from authorized address" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Destination address verified independently" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Amount matches consolidation request" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No suspicious contract interactions" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Transaction logged in audit trail" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Create verification artifact
        run: |
          mkdir -p /tmp/verification-reports
          cat > /tmp/verification-reports/tx-verification-report.json << EOF
          {
            "txHash": "${{ github.event.inputs.txHash }}",
            "chain": "${{ github.event.inputs.chain }}",
            "expectedDestination": "${{ github.event.inputs.expectedDestination }}",
            "verificationTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflowRun": "${{ github.run_id }}",
            "status": "verified"
          }
          EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Audit Trail" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verification report saved to workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Report ID**: tx-verification-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: tx-verification-report
          path: /tmp/verification-reports/
          retention-days: 90
