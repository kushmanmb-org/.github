name: Secret Scanning

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks Enterprise

    - name: Check for hardcoded secrets in code
      run: |
        echo "## Secret Scanning Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for common secret patterns
        ISSUES_FOUND=false
        
        # Check for hardcoded API keys
        if grep -r "api[_-]key\s*=\s*['\"][^'\"]*['\"]" --include="*.py" --include="*.js" --include="*.sh" . | grep -v "YOUR_API_KEY\|YourApiKeyToken\|example"; then
          echo "⚠️ Warning: Potential hardcoded API keys found" >> $GITHUB_STEP_SUMMARY
          ISSUES_FOUND=true
        fi
        
        # Check for hardcoded passwords
        if grep -r "password\s*=\s*['\"][^'\"]*['\"]" --include="*.py" --include="*.js" --include="*.sh" . | grep -v "YOUR_PASSWORD\|example\|password.*required"; then
          echo "⚠️ Warning: Potential hardcoded passwords found" >> $GITHUB_STEP_SUMMARY
          ISSUES_FOUND=true
        fi
        
        # Check for private keys in non-gitignored locations
        if find . -type f \( -name "*.key" -o -name "*.pem" \) ! -path "./.git/*" ! -path "./.github/*" 2>/dev/null | head -1 | grep -q .; then
          echo "⚠️ Warning: Private key files found (should be gitignored)" >> $GITHUB_STEP_SUMMARY
          ISSUES_FOUND=true
        fi
        
        if [ "$ISSUES_FOUND" = false ]; then
          echo "✅ No obvious secrets found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For more details, see [SECURITY_BEST_PRACTICES.md](../SECURITY_BEST_PRACTICES.md)" >> $GITHUB_STEP_SUMMARY

    - name: Verify .gitignore coverage
      run: |
        echo "## .gitignore Coverage Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verify critical patterns are in .gitignore
        PATTERNS=(".env" "*.key" "*.pem" "*secrets*" "*credentials*" "*apikey*")
        MISSING_PATTERNS=()
        
        for pattern in "${PATTERNS[@]}"; do
          if ! grep -q "$pattern" .gitignore; then
            MISSING_PATTERNS+=("$pattern")
          fi
        done
        
        if [ ${#MISSING_PATTERNS[@]} -eq 0 ]; then
          echo "✅ All critical patterns are in .gitignore" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Missing .gitignore patterns:" >> $GITHUB_STEP_SUMMARY
          for pattern in "${MISSING_PATTERNS[@]}"; do
            echo "  - $pattern" >> $GITHUB_STEP_SUMMARY
          done
        fi
